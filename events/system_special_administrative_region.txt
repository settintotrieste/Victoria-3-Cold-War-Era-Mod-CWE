namespace = special_administrative_region_system

#Convert certain subjects into SARs
special_administrative_region_system.1 = {
	type = country_event

	title = special_administrative_region_system.1.t
	desc = special_administrative_region_system.1.d
	flavor = special_administrative_region_system.1.f

	event_image = {
		video = "gfx/event_pictures/unspecific_ruler_speaking_to_people.bk2"
	}

	icon = "gfx/interface/icons/event_icons/event_scales.dds"

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/unspecific/leader_speaking_to_a_group_of_people"

	duration = 1

	trigger = {
	
		#Any subject of THIS has a capital state that has a homeland of THIS
		any_country = {
			is_direct_subject_of = ROOT
			capital = { is_homeland_of_country_cultures = ROOT }
			OR = { 
				is_subject_type = subject_type_puppet
				is_subject_type = subject_type_semi_autonomous_colony
			}
		}
		
		#Prevent event from firing 2 times at the same time
		NOT = { has_variable = special_administrative_region_system }
		
	}

	immediate = {
	
		#Mark subject to be converted into an SAR
		random_country = {
			limit = { 
				is_direct_subject_of = ROOT
				capital = { is_homeland_of_country_cultures = ROOT }
				OR = { 
					is_subject_type = subject_type_puppet
					is_subject_type = subject_type_semi_autonomous_colony
				}
			}
			save_scope_as = SAR_country
		}
		
		#Prevent event from firing 2 times at the same time
		set_variable = special_administrative_region_system
		
	}

	option = {
		name = special_administrative_region_system_option #Unfortunate
		default_option = yes
		
		#Turn subject into an SAR
		custom_tooltip = {
			text = DIPLO_ACTION_CREATE_SAR_SUBJECT_TYPE
			scope:SAR_country = { make_independent = yes }
			create_diplomatic_pact = {
				country = scope:SAR_country
				type = special_administrative_region
			}
		}
		
		#Event can fire again once option is selected
		remove_variable = special_administrative_region_system
		
	}
	
}

#Condominium System
special_administrative_region_system.2 = {
	type = country_event
	hidden = yes

	trigger = {
		
		#Set flags
		OR = {
			AND = { 
				NOT = { has_modifier = condominium_modifier }
				any_country = { has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes } }
			}
			AND = { 
				has_modifier = condominium_modifier
				NOT = { any_country = { has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes } } }
			}
			AND = {
				has_modifier = condominium_modifier
				any_country = { 
					has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes }
					NOT = { has_war_with = ROOT }
					NOT = { 
						any_scope_treaty = {
							binds = ROOT
							any_scope_article = {
								has_type = guarantee_independence
								target_country = ROOT
							}
						}
					}
				}
			}
		}
		
	}

	immediate = {
		
		if = {
			limit = { 
				any_country = { has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes } }
				NOT = { has_modifier = condominium_modifier }
			}
			add_modifier = { name = condominium_modifier }
		}
		else_if = {
			limit = { 
				NOT = { any_country = { has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes } } }
				has_modifier = condominium_modifier
			}
			
			#End Condominium
			remove_modifier = condominium_modifier
			
			#Return to Reversionary Owner
			if = {
				limit = { is_subject = no }
				hidden_effect = { make_indepedent = yes }
				random_country = {
					limit = {
						has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes }
					}
					save_scope_as = condominium_reversionary_owner
					if = {
						limit = { ROOT.capital = { is_homeland_of_country_cultures = scope:condominium_reversionary_owner } }
						create_diplomatic_pact = {
							country = ROOT
							type = special_administrative_region
						}
					}
					else = {
						create_diplomatic_pact = {
							country = ROOT
							type = semi_autonomous_colony
						}
					}
				}
			}
		
		}
		if = {
			limit = {
				has_modifier = condominium_modifier
				any_country = { 
					has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes }
					NOT = { has_war_with = ROOT }
					NOT = { 
						any_scope_treaty = {
							binds = ROOT
							any_scope_article = {
								has_type = guarantee_independence
								target_country = ROOT
							}
						}
					}
				}
			}
			every_country = {
				limit = {
					has_diplomatic_pact = { who = ROOT type = condominium is_initiator = yes }
					NOT = { has_war_with = ROOT }
					NOT = { 
						any_scope_treaty = {
							binds = ROOT
							any_scope_article = {
								has_type = guarantee_independence
								target_country = ROOT
							}
						}
					}
				}
				create_treaty = {
					name = treaty_name_generic_condominium
					first_country = THIS
					second_country = ROOT

					is_draft = no

					articles_to_create = {
						{
							article = guarantee_independence
							source_country = THIS
							target_country = ROOT
						}
						{
							article = foreign_investment_rights
							target_country = THIS
							source_country = ROOT
						}
						{
							article = trade_privilege
							target_country = THIS
							source_country = ROOT
						}
						{
							article = military_access
							target_country = THIS
							source_country = ROOT
						}
					}
				}
			}
		}
		
	}

}