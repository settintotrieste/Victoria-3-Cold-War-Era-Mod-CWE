je_OPEC_system = {
	icon = "gfx/interface/icons/diplo_icons/OPEC_member.dds"

	group = je_group_international_organisations
	
	scripted_button = je_OPEC_increase_oil_quota_button
	scripted_button = je_OPEC_decrease_oil_quota_button
	
	scripted_button = je_OPEC_ignore_oil_quota_button
	scripted_button = je_OPEC_restore_oil_quota_button
	
	is_shown_when_inactive = {
		
	}
	
	possible = {
		
		#OPEC eligible
		OR = { 
			has_modifier = OPEC_member 
			has_modifier = OPEC_leader
		}
		
	}

	immediate = {
		
		random_country = {
			limit = {
				OR = {
					has_modifier = OPEC_member 
					has_modifier = OPEC_leader
				}
			}
			
			#Count OPEC members
			set_global_variable = { 
				name = OPEC_member_count
				value = 0 
			}
			every_country = {
				limit = {
					OR = { 
						has_modifier = OPEC_member
						has_modifier = OPEC_leader
					}
				}
				change_global_variable = {
					name = OPEC_member_count
					add = 1
				}
			}
		
			#Apply initial Oil Quota
			if = {
				limit = { 
					NOR = {
						has_global_variable = very_high_OPEC_oil_quota
						has_global_variable = high_OPEC_oil_quota
						has_global_variable = medium_OPEC_oil_quota
						has_global_variable = low_OPEC_oil_quota
						has_global_variable = very_low_OPEC_oil_quota
					}
				}
				set_global_variable = medium_OPEC_oil_quota
				set_OPEC_quota_modifiers = yes
			}
			
		}
		
		#Mark leader
		random_country = {
			limit = { has_modifier = OPEC_leader }
			save_scope_as = OPEC_leader
		}
		
	}
	
	on_monthly_pulse = {
		
		effect = {
		
			random_country = {
				limit = {
					has_modifier = OPEC_leader
				}
			
				#Count OPEC members
				set_global_variable = { 
					name = OPEC_member_count
					value = 0 
				}
				every_country = {
					limit = {
						OR = { 
							has_modifier = OPEC_member
							has_modifier = OPEC_leader
						}
					}
					change_global_variable = {
						name = OPEC_member_count
						add = 1
					}
				}
				
			}
			
			#Check OPEC quota
			if = {
				limit = { 
					NOR = {
						has_global_variable = very_high_OPEC_oil_quota
						has_global_variable = high_OPEC_oil_quota
						has_global_variable = medium_OPEC_oil_quota
						has_global_variable = low_OPEC_oil_quota
						has_global_variable = very_low_OPEC_oil_quota
					}
				}
				set_global_variable = medium_OPEC_oil_quota
				set_OPEC_quota_modifiers = yes
			}
			if = {
				limit = { NOT = { has_variable = OPEC_oil_quota_defiance } }
				set_OPEC_quota_modifiers = yes
			}
			
			#Clean up
			if = {
				limit = { 
					has_variable = OPEC_oil_quota_defiance
					has_modifier = OPEC_leader
				}
				remove_variable = OPEC_oil_quota_defiance
			}
			
		}
		
	}
	
	on_yearly_pulse = {
		
		effect = {
			
			
		}
		
	}

	invalid = {
		
		OR = {
		
			#No more members of org
			any_country = {
				count < 1
				OR = { 
					has_modifier = OPEC_member
					has_modifier = OPEC_leader
				}
			}
			
			#Different leader
			scope:OPEC_leader ?= {
				NOT = { has_modifier = OPEC_leader }
			}
			
			NOT = { exists = scope:OPEC_leader }
			
		}
		
	}
	
	on_invalid = {
	
		#Clear variables
		remove_variable = OPEC_oil_quota_defiance
		
	}
	
	status_desc = {
		first_valid = {
			triggered_desc = {
				desc = very_low_OPEC_oil_quota
				trigger = {
					has_global_variable = very_low_OPEC_oil_quota
				}
			}
			triggered_desc = {
				desc = low_OPEC_oil_quota
				trigger = {
					has_global_variable = low_OPEC_oil_quota
				}
			}
			triggered_desc = {
				desc = medium_OPEC_oil_quota
				trigger = {
					has_global_variable = medium_OPEC_oil_quota
				}
			}
			triggered_desc = {
				desc = high_OPEC_oil_quota
				trigger = {
					has_global_variable = high_OPEC_oil_quota
				}
			}
			triggered_desc = {
				desc = very_high_OPEC_oil_quota
				trigger = {
					has_global_variable = very_high_OPEC_oil_quota
				}
			}
		}
	}

	weight = 100

	should_be_pinned_by_default = no

	transferable = no

	progressbar = no
	
}